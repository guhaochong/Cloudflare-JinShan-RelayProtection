<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>幸运大抽奖 优化版</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f4f4f4, #e0e0e0);
            color: #333;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }

        h1, h2, h3 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
        }

        h1 {
            margin-top: 40px;
            font-size: 2.4em;
        }

        .container {
            text-align: center;
            margin-bottom: 30px;
            z-index: 2;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #007aff, #005bbb);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        button:hover {
            background: linear-gradient(135deg, #0066cc, #004a99);
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .confirm-btn-save {
            background: linear-gradient(135deg, #ff9500, #e08600);
        }

        .confirm-btn-save:hover {
            background: linear-gradient(135deg, #e08600, #c77300);
        }

        .confirm-btn-clear {
            background: linear-gradient(135deg, #4cd964, #38c84a);
        }

        .confirm-btn-clear:hover {
            background: linear-gradient(135deg, #38c84a, #2ea741);
        }

        .exit-btn {
            background: linear-gradient(135deg, #ff4444, #cc3333);
        }

        .exit-btn:hover {
            background: linear-gradient(135deg, #cc3333, #aa2222);
        }

        .export-btn {
            background: linear-gradient(135deg, #ff9500, #e08600);
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #e08600, #c77300);
        }

        #bubble-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
        }

        .prize-bubble {
            position: absolute;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85));
            color: #333;
            padding: 16px 24px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: default;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(200, 200, 255, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prize-bubble.large {
            padding: 24px 36px;
            font-size: 1.5em;
        }

        .prize-bubble.small {
            padding: 12px 20px;
            font-size: 0.9em;
        }

        .prize-bubble:hover {
            border-color: #007aff;
            transform: scale(1.08);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .prize-bubble.active {
            background: linear-gradient(135deg, #ffdd66, #ffcc00) !important;
            color: #fff !important;
            z-index: 3;
            transform: scale(1.15);
        }

        .prize-bubble.winner-effect {
            background: linear-gradient(135deg, #4cd964, #38c84a) !important;
            color: #fff !important;
            z-index: 4;
            transform: scale(1.15);
        }

        .prize-bubble.won-prize {
            background: rgba(200, 200, 200, 0.5) !important;
            color: #999 !important;
            transform: scale(1);
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(2deg); }
            50% { transform: translateY(-12px) rotate(-2deg); }
        }

        @keyframes confetti {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(150px) scale(0.5); }
        }

        .emoji {
            position: absolute;
            font-size: 180px;
            pointer-events: none;
            animation: confetti 1.5s ease-out forwards;
        }

        #settingsPanel, #historyPanel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            padding: 20px;
            overflow: auto;
            backdrop-filter: blur(8px);
        }

        #settingsPanel::before, #historyPanel::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: -1;
        }

        #settingsContent, #historyContent {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
        }

        #settingsContent .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        #settingsContent .section:last-child {
            border-bottom: none;
        }

        #settingsContent textarea, #passwordPanel input[type="password"] {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease;
            font-size: 14px;
            margin: 0 auto;
            display: block;
        }

        #settingsContent textarea:focus, #passwordPanel input[type="password"]:focus {
            border-color: #007aff;
            outline: none;
        }

        #settingsContent textarea {
            resize: vertical;
            max-height: 200px;
            overflow-y: auto;
        }

        #settingsContent input[type="number"] {
            width: 60px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-align: right;
            font-size: 14px;
            margin-left: 10px;
        }

        #probabilityInputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .probability-input-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .probability-input-item label {
            flex: 1;
            font-size: 14px;
            color: #555;
        }

        .probability-input-item input {
            width: 60px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-align: right;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .probability-input-item input:focus {
            border-color: #007aff;
            outline: none;
        }

        #totalProbability {
            color: #f44336;
            font-weight: bold;
        }

        .settings-options .option-group {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .settings-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #555;
            cursor: pointer;
        }

        .settings-options input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #007aff;
            border-radius: 4px;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .settings-options input[type="checkbox"]:checked {
            background: #007aff;
        }

        .settings-options input[type="checkbox"]:checked::after {
            content: '✔';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 14px;
        }

        .settings-options input[type="radio"] {
            margin-left: 10px;
        }

        #historyContent table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #historyContent th, #historyContent td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #historyContent th {
            background: #f5f5f5;
            font-weight: bold;
        }

        #historyContent tbody tr:nth-child(even) {
            background: #fafafa;
        }

        #lotteryEndAlert {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #fff, #f0f0ff);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid #4cd964;
            z-index: 1001;
            text-align: center;
            overflow: hidden;
            max-width: 300px;
        }

        #lotteryEndAlert::before {
            content: '🎉 🎊 🎁 💰 🏆 ✨';
            position: absolute;
            top: -30px;
            left: 0;
            width: 100%;
            font-size: 40px;
            text-align: center;
            white-space: nowrap;
            animation: emojiScroll 10s linear infinite;
        }

        #lotteryEndAlert::after {
            content: '🎈 🎂 🥇 🥈 🥉 🎵';
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            font-size: 40px;
            text-align: center;
            white-space: nowrap;
            animation: emojiScroll 10s linear infinite reverse;
        }

        @keyframes emojiScroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        #lotteryEndAlert h2 {
            background: linear-gradient(90deg, #ff4444, #ff9500, #4cd964, #007aff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        #lotteryEndAlert p {
            font-size: 1em;
            color: #555;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        #lotteryEndAlert .prize-name {
            font-weight: bold;
            color: #4cd964;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #lotteryEndAlert .congrats-text {
            font-style: italic;
            color: #555;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }

        #lotteryEndAlert button {
            background: linear-gradient(135deg, #4cd964, #38c84a);
            border-radius: 50px;
            padding: 10px 20px;
        }

        #roundCounter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 20px;
            color: #333;
            z-index: 5;
        }

        #countdownTimer {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 150px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 20px;
            color: #333;
            z-index: 5;
        }

        /* 手机端适配 */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            button {
                padding: 10px 20px;
                font-size: 14px;
            }

            .prize-bubble {
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .prize-bubble.large {
                padding: 18px 28px;
                font-size: 1.2em;
            }

            .prize-bubble.small {
                padding: 8px 16px;
                font-size: 0.7em;
            }

            #lotteryEndAlert {
                max-width: 200px;
                padding: 15px;
            }

            #lotteryEndAlert h2 {
                font-size: 2em;
            }

            #lotteryEndAlert p {
                font-size: 0.9em;
            }

            #lotteryEndAlert button {
                padding: 8px 16px;
                font-size: 12px;
            }

            #roundCounter {
                padding: 8px 16px;
                font-size: 16px;
                right: 10px;
            }

            #countdownTimer {
                padding: 8px 16px;
                font-size: 16px;
                right: 100px;
            }
        }
    </style>
</head>
<body>
    <div id="bubble-container"></div>
    <div class="container">
        <h1>幸运大抽奖</h1>
        <div class="buttons">
            <button id="startBtn" onclick="startLottery()">开始抽奖</button>
            <button id="stopBtn" onclick="stopLottery()" style="display:none;">停止抽奖</button>
            <button onclick="toggleSettings()">抽奖设置</button>
            <button onclick="toggleHistoryPanel()">抽奖记录</button>
        </div>
    </div>

    <div id="settingsPanel">
        <h2>抽奖设置</h2>
        <div id="passwordPanel">
            <div style="text-align: center;">
                <input type="password" id="password" placeholder="请输入密码">
                <button onclick="checkPassword()" style="margin: 10px;">确认</button>
                <button class="exit-btn" onclick="toggleSettings()" style="margin: 10px;">退出设置</button>
            </div>
        </div>
        <div id="settingsContent" style="display:none;">
            <div class="section">
                <h3>奖品列表</h3>
                <textarea id="prizeList" rows="5" placeholder="请输入奖品，每行一个（最多50个）"></textarea>
                <button onclick="importPrizes()">导入奖品</button>
            </div>
            <div class="section">
                <h3>中奖概率设置</h3>
                <div id="probabilityInputs"></div>
                <p>总概率: <span id="totalProbability">0</span>%</p>
                <p style="font-size: 12px; color: #666;">说明：页面共有200个气泡，奖品数量根据概率分配。例如，概率为50%的奖品将分配100个气泡。</p>
                <div class="setting-buttons" style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="autoDistribute()">平均分配</button>
                    <button onclick="clearProbabilities()">清除比例</button>
                </div>
            </div>
            <div class="section">
                <h3>功能选项</h3>
                <div class="settings-options">
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="nonRepeatCheckbox" onclick="toggleNonRepeatable()"> 不重复中奖
                        </label>
                    </div>
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="enableCountdownCheckbox" onclick="toggleCountdown()"> 倒计时器
                            <input type="number" id="countdownTimeInput" min="1" max="5" value="3" placeholder="秒数 (1-5)"> 秒
                            <input type="number" id="drawCountInput" min="1" value="1" placeholder="抽奖次数"> 抽奖次数
                        </label>
                        <div style="margin-top: 10px;">
                            <label><input type="radio" name="countdownMode" value="manual" checked onclick="updateCountdownMode()"> 手动模式</label>
                            <label><input type="radio" name="countdownMode" value="auto" onclick="updateCountdownMode()"> 自动模式</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="setting-buttons" style="display: flex; gap: 10px; justify-content: center;">
                <button class="confirm-btn-save" onclick="saveProbabilities()">保存设置</button>
                <button class="confirm-btn-clear" onclick="clearAllConfig()">清空全部配置</button>
                <button class="exit-btn" onclick="toggleSettings()">退出设置</button>
            </div>
        </div>
    </div>

    <div id="historyPanel">
        <h2>抽奖记录</h2>
        <div id="historyContent"></div>
        <div class="setting-buttons" style="display: flex; gap: 10px; justify-content: center;">
            <button class="export-btn" onclick="exportRecords()">导出记录</button>
            <button class="exit-btn" onclick="clearRecords()">清空记录</button>
            <button onclick="toggleHistoryPanel()">关闭</button>
        </div>
    </div>

    <div id="lotteryEndAlert">
        <h2 id="prizeTitle">🎉 <span class="prize-name"></span> 🎉</h2>
        <p id="congratsMessage"><span class="congrats-text"></span></p>
        <button onclick="closeLotteryEndAlert()">确定</button>
    </div>

    <div id="countdownTimer">倒计时: 0秒</div>
    <div id="roundCounter">当前轮次: 0</div>

    <script>
        let prizes = JSON.parse(localStorage.getItem('prizes')) || ['特等奖', '一等奖', '二等奖', '三等奖', '谢谢惠顾'];
        let prizeProbabilities = JSON.parse(localStorage.getItem('prizeProbabilities')) || {
            '特等奖': 5, '一等奖': 10, '二等奖': 15, '三等奖': 20, '谢谢惠顾': 50
        };
        let isDrawing = false;
        let intervalId = null;
        let currentIndex = 0;
        let wonPrizeTypes = JSON.parse(localStorage.getItem('wonPrizeTypes')) || [];
        let isNonRepeatableEnabled = JSON.parse(localStorage.getItem('nonRepeatable')) || false;
        let isCountdownEnabled = JSON.parse(localStorage.getItem('countdownEnabled')) || false;
        let countdownTime = parseInt(localStorage.getItem('countdownTime')) || 3;
        let drawCount = parseInt(localStorage.getItem('drawCount')) || 1;
        let countdownMode = localStorage.getItem('countdownMode') || 'manual';
        let remainingDraws = 0;
        let countdownInterval = null;
        const password = localStorage.getItem('lotteryPassword') || '123';
        if (!localStorage.getItem('lotteryPassword')) localStorage.setItem('lotteryPassword', '123');
        let allBubbles = [];
        const MAX_PRIZES = 50;
        const TOTAL_BUBBLES = 200;
        let roundCounter = parseInt(localStorage.getItem('roundCounter')) || 0;

        const congratsMessages = [
            "哈哈，今天运气爆棚啊！",
            "牛啊，晚上请客不？",
            "我的天，运气王就是你！",
            "你这是要逆天啊，兄弟！",
            "哇塞，赶紧去炫耀一波吧！",
            "不得了，你是抽奖界的隐藏大佬吧？",
            "恭喜恭喜，今晚睡着都能笑醒！",
            "哎呀，你这运气能去买彩票了吧？",
            "厉害了我的哥，羡慕死我了！",
            "你这是要上天和太阳肩并肩啊！",
            "哈哈哈，今天是你的幸运日！",
            "天啊，你这手气也太逆天了吧！",
            "恭喜你啊，赶紧发个朋友圈显摆一下！",
            "不得了，你这是要成为传奇啊！",
            "哇，今天你是全场最靓的仔！",
            "中奖啦，你这运气我服了！",
            "嘿，抽奖大师就是你没错了！",
            "恭喜你，笑得我脸都抽筋了！",
            "牛逼，你这是要抢走所有好运啊！",
            "哈哈，运气好得让人想报警！",
            "你这手气，简直是开挂了吧！",
            "天选之人啊，佩服佩服！",
            "哇塞，今天你是抽奖界的扛把子！",
            "恭喜啦，赶紧去庆祝一波吧！",
            "不得了，你这运气能开店了吧！",
            "哈哈，今天你是全场焦点！",
            "中奖啦，笑得我眼泪都出来了！",
            "牛啊，你这是要上天啊！",
            "恭喜你，运气好得让人嫉妒！",
            "哇，你这是要火遍全网啊！"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nonRepeatCheckbox').checked = isNonRepeatableEnabled;
            document.getElementById('enableCountdownCheckbox').checked = isCountdownEnabled;
            document.getElementById('countdownTimeInput').value = countdownTime;
            document.getElementById('drawCountInput').value = drawCount;
            document.querySelector(`input[name="countdownMode"][value="${countdownMode}"]`).checked = true;
            initPrizes();
            updateRoundCounter();
            toggleCountdown();
        });

        function initPrizes() {
            const bubbleContainer = document.getElementById('bubble-container');
            bubbleContainer.innerHTML = '';
            wonPrizeTypes = JSON.parse(localStorage.getItem('wonPrizeTypes')) || [];
            allBubbles = [];

            let bubbleCounts = {};
            let assignedBubbles = 0;

            prizes.forEach(prize => {
                let count = Math.round(TOTAL_BUBBLES * (prizeProbabilities[prize] / 100));
                bubbleCounts[prize] = count;
                assignedBubbles += count;
            });

            let diff = TOTAL_BUBBLES - assignedBubbles;
            if (diff !== 0) {
                let lastPrize = prizes[prizes.length - 1];
                bubbleCounts[lastPrize] += diff;
                if (bubbleCounts[lastPrize] < 0) bubbleCounts[lastPrize] = 0;
            }

            let totalToCreate = 0;
            for (let prize in bubbleCounts) totalToCreate += bubbleCounts[prize];

            function createBubbles(index = 0) {
                if (index >= prizes.length) return;
                const prize = prizes[index];
                for (let i = 0; i < bubbleCounts[prize] && allBubbles.length < totalToCreate; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'prize-bubble';
                    bubble.textContent = prize;
                    bubble.dataset.prizeName = prize;

                    if (Math.random() > 0.5) {
                        bubble.classList.add('large');
                    } else {
                        bubble.classList.add('small');
                    }

                    if (isNonRepeatableEnabled && wonPrizeTypes.includes(prize)) {
                        bubble.classList.add('won-prize');
                    }

                    let left, top, attempts = 0;
                    const title = document.querySelector('h1');
                    const titleRect = title ? title.getBoundingClientRect() : { left: 0, right: 0, top: 0, bottom: 0 };
                    do {
                        left = Math.random() * (bubbleContainer.offsetWidth - bubble.offsetWidth);
                        top = Math.random() * (Math.min(bubbleContainer.offsetHeight * 0.8, window.innerHeight) - bubble.offsetHeight);
                        attempts++;
                    } while (attempts < 100 &&
                        left > titleRect.left - 100 &&
                        left < titleRect.right + 100 &&
                        top > titleRect.top - 50 &&
                        top < titleRect.bottom + 50);

                    bubble.style.left = `${left}px`;
                    bubble.style.top = `${top}px`;
                    bubble.style.animation = `float ${3 + Math.random() * 3}s infinite ${Math.random() * 3}s`;
                    bubbleContainer.appendChild(bubble);
                    allBubbles.push(bubble);
                }
                if (allBubbles.length < totalToCreate) {
                    requestAnimationFrame(() => createBubbles(index + 1));
                } else {
                    loadWonPrizesVisual();
                }
            }
            createBubbles();
        }

        function startLottery() {
            if (isDrawing) return;
            isDrawing = true;
            let bubbles = allBubbles.filter(bubble => !(isNonRepeatableEnabled && wonPrizeTypes.includes(bubble.dataset.prizeName)));

            if (isNonRepeatableEnabled && bubbles.length === 0) {
                isDrawing = false;
                document.getElementById('lotteryEndAlert').style.display = 'block';
                document.getElementById('prizeTitle').innerHTML = '🎉 <span class="prize-name">所有奖品已抽完！</span> 🎉';
                document.getElementById('congratsMessage').innerHTML = '';
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
                return;
            }

            bubbles.forEach(b => {
                b.classList.remove('active', 'winner-effect');
                b.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                b.style.color = '#333';
            });
            currentIndex = Math.floor(Math.random() * bubbles.length);

            intervalId = setInterval(() => {
                bubbles[currentIndex].classList.remove('active');
                bubbles[currentIndex].style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                bubbles[currentIndex].style.color = '#333';
                currentIndex = (currentIndex + 1) % bubbles.length;
                bubbles[currentIndex].classList.add('active');
                bubbles[currentIndex].style.background = 'linear-gradient(135deg, #ffdd66, #ffcc00)';
                bubbles[currentIndex].style.color = '#fff';
            }, 60);

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('stopBtn').disabled = isCountdownEnabled;

            if (isCountdownEnabled) {
                remainingDraws = drawCount;
                startCountdown();
            }
        }

        function startCountdown() {
            let timeLeft = countdownTime;
            document.getElementById('countdownTimer').style.display = 'block';
            document.getElementById('countdownTimer').textContent = `倒计时: ${timeLeft}秒`;

            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('countdownTimer').textContent = `倒计时: ${timeLeft}秒`;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    stopLottery();
                    if (countdownMode === 'auto' && remainingDraws > 0) {
                        let remainingBubbles = allBubbles.filter(b => !(isNonRepeatableEnabled && wonPrizeTypes.includes(b.dataset.prizeName)));
                        if (remainingBubbles.length > 0) {
                            setTimeout(startLottery, 1000);
                        } else {
                            document.getElementById('countdownTimer').style.display = 'none';
                        }
                    } else {
                        document.getElementById('countdownTimer').style.display = 'none';
                    }
                }
            }, 1000);
        }

        function stopLottery() {
            if (!isDrawing) return;
            isDrawing = false;
            clearInterval(intervalId);
            if (countdownInterval) clearInterval(countdownInterval);

            let bubbles = allBubbles.filter(bubble => !(isNonRepeatableEnabled && wonPrizeTypes.includes(bubble.dataset.prizeName)));
            if (isNonRepeatableEnabled && bubbles.length === 0) {
                document.getElementById('lotteryEndAlert').style.display = 'block';
                document.getElementById('prizeTitle').innerHTML = '🎉 <span class="prize-name">所有奖品已抽完！</span> 🎉';
                document.getElementById('congratsMessage').innerHTML = '';
                document.getElementById('countdownTimer').style.display = 'none';
                return;
            }

            const winner = bubbles[currentIndex];
            const prize = winner.dataset.prizeName;

            bubbles.forEach(b => {
                b.classList.remove('active');
                b.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                b.style.color = '#333';
            });

            winner.classList.remove('active');
            winner.classList.add('winner-effect');
            winner.style.background = 'linear-gradient(135deg, #4cd964, #38c84a)';
            winner.style.color = '#fff';

            const emojis = ['🎉', '🎊', '🎁', '💰', '🏆', '✨', '🎈', '🎂', '🥇', '🥈', '🥉', '🎵', '🎸', '🎤', '🎭', '🎪', '🎮', '🎰', '🎳', '🎯'];
            for (let i = 0; i < 6; i++) {
                const emoji = document.createElement('div');
                emoji.className = 'emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = `${Math.random() * 300 - 150}px`;
                emoji.style.top = `${Math.random() * 300 - 150}px`;
                winner.appendChild(emoji);
            }

            if (isNonRepeatableEnabled) {
                wonPrizeTypes.push(prize);
                localStorage.setItem('wonPrizeTypes', JSON.stringify(wonPrizeTypes));
                loadWonPrizesVisual();
            }

            roundCounter++;
            localStorage.setItem('roundCounter', roundCounter);
            saveRecord(prize);
            updateRoundCounter();

            const randomMessage = congratsMessages[Math.floor(Math.random() * congratsMessages.length)];
            document.getElementById('lotteryEndAlert').style.display = 'block';
            document.getElementById('prizeTitle').innerHTML = `🎉 <span class="prize-name">${prize}</span> 🎉`;
            document.getElementById('congratsMessage').innerHTML = `<span class="congrats-text">${randomMessage}</span>`;

            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            remainingDraws--;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            if (panel.style.display === 'block') {
                document.getElementById('passwordPanel').style.display = 'block';
                document.getElementById('settingsContent').style.display = 'none';
            }
        }

        function checkPassword() {
            const inputPassword = document.getElementById('password').value;
            if (inputPassword === password) {
                document.getElementById('passwordPanel').style.display = 'none';
                document.getElementById('settingsContent').style.display = 'block';
                generateProbabilityInputs();
            } else {
                alert('密码错误！');
            }
        }

        function importPrizes() {
            const list = document.getElementById('prizeList').value.split('\n')
                .map(item => item.trim())
                .filter(item => item);

            if (list.length === 0) {
                alert('请至少输入一个奖品！');
                return;
            }
            if (list.length > MAX_PRIZES) {
                alert(`奖品种类不得超过 ${MAX_PRIZES} 个！`);
                return;
            }

            prizes = list;
            prizeProbabilities = {};
            wonPrizeTypes = [];
            localStorage.removeItem('wonPrizeTypes');
            prizes.forEach(prize => prizeProbabilities[prize] = 0);
            localStorage.setItem('prizes', JSON.stringify(prizes));
            localStorage.setItem('prizeProbabilities', JSON.stringify(prizeProbabilities));

            initPrizes();
            generateProbabilityInputs();
            alert('奖品导入成功！请设置中奖概率。');
        }

        function generateProbabilityInputs() {
            const container = document.getElementById('probabilityInputs');
            container.innerHTML = '';

            prizes.forEach(prize => {
                const div = document.createElement('div');
                div.className = 'probability-input-item';
                div.innerHTML = `
                    <label>${prize}:</label>
                    <input type="number" step="1" value="${prizeProbabilities[prize] || 0}"
                           min="0" max="100" onchange="updateTotalProbability()">
                    <span>%</span>
                `;
                container.appendChild(div);
            });
            updateTotalProbability();
        }

        function updateTotalProbability() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            let total = Array.from(inputs).reduce((sum, input) => sum + parseInt(input.value || 0), 0);
            document.getElementById('totalProbability').textContent = total;
        }

        function autoDistribute() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            const avg = Math.floor(100 / inputs.length);
            let remaining = 100 - avg * inputs.length;

            inputs.forEach((input, index) => {
                input.value = avg + (index < remaining ? 1 : 0);
            });
            updateTotalProbability();
        }

        function clearProbabilities() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            inputs.forEach(input => input.value = 0);
            updateTotalProbability();
        }

        function saveProbabilities() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            let total = Array.from(inputs).reduce((sum, input) => sum + parseInt(input.value || 0), 0);

            if (total !== 100) {
                alert('总概率必须为100%！');
                return;
            }

            prizeProbabilities = {};
            inputs.forEach((input, index) => {
                prizeProbabilities[prizes[index]] = parseFloat(input.value);
            });

            localStorage.setItem('prizeProbabilities', JSON.stringify(prizeProbabilities));
            initPrizes();
            alert('概率设置保存成功！');
            toggleSettings();
        }

        function saveRecord(prize) {
            const records = JSON.parse(localStorage.getItem('lotteryRecords') || '[]');
            records.push({
                round: roundCounter,
                time: new Date().toLocaleString(),
                prize: prize
            });
            localStorage.setItem('lotteryRecords', JSON.stringify(records));
        }

        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            if (panel.style.display === 'block') loadRecords();
        }

        function loadRecords() {
            const content = document.getElementById('historyContent');
            content.innerHTML = '';
            const records = JSON.parse(localStorage.getItem('lotteryRecords') || '[]');
            if (records.length === 0) {
                content.innerHTML = '<p>暂无抽奖记录</p>';
                return;
            }

            let tableHTML = '<table><thead><tr><th>轮次</th><th>时间</th><th>奖品名称</th></tr></thead><tbody>';
            records.forEach(record => {
                tableHTML += `<tr><td>${record.round}</td><td>${record.time}</td><td>${record.prize}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            content.innerHTML = tableHTML;
        }

        function clearRecords() {
            if (confirm('确定要清空所有抽奖记录吗？')) {
                localStorage.removeItem('lotteryRecords');
                wonPrizeTypes = [];
                localStorage.removeItem('wonPrizeTypes');
                roundCounter = 0;
                localStorage.setItem('roundCounter', roundCounter);
                loadRecords();
                initPrizes();
                updateRoundCounter();
                alert('抽奖记录已清空，程序已恢复初始状态。');
            }
        }

        function exportRecords() {
            const records = JSON.parse(localStorage.getItem('lotteryRecords') || '[]');
            if (records.length === 0) {
                alert('暂无记录可导出。');
                return;
            }

            let mdContent = "# 抽奖记录\n\n| 轮次 | 时间 | 奖品名称 |\n|------|------|----------|\n";
            records.forEach(record => {
                mdContent += `| ${record.round} | ${record.time} | ${record.prize} |\n`;
            });

            const blob = new Blob([mdContent], { type: 'text/markdown;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "lottery_records.md");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function toggleNonRepeatable() {
            isNonRepeatableEnabled = document.getElementById('nonRepeatCheckbox').checked;
            localStorage.setItem('nonRepeatable', JSON.stringify(isNonRepeatableEnabled));
            initPrizes();
            loadWonPrizesVisual();
        }

        function toggleCountdown() {
            isCountdownEnabled = document.getElementById('enableCountdownCheckbox').checked;
            countdownTime = Math.max(1, Math.min(5, parseInt(document.getElementById('countdownTimeInput').value) || 3));
            drawCount = Math.max(1, parseInt(document.getElementById('drawCountInput').value) || 1);
            localStorage.setItem('countdownEnabled', JSON.stringify(isCountdownEnabled));
            localStorage.setItem('countdownTime', countdownTime);
            localStorage.setItem('drawCount', drawCount);
            document.getElementById('countdownTimer').style.display = isCountdownEnabled ? 'block' : 'none';
            document.getElementById('countdownTimer').textContent = `倒计时: ${countdownTime}秒`;
        }

        function updateCountdownMode() {
            countdownMode = document.querySelector('input[name="countdownMode"]:checked').value;
            localStorage.setItem('countdownMode', countdownMode);
        }

        function loadWonPrizesVisual() {
            allBubbles.forEach(bubble => {
                bubble.classList.remove('active', 'winner-effect');
                if (isNonRepeatableEnabled && wonPrizeTypes.includes(bubble.dataset.prizeName)) {
                    bubble.classList.add('won-prize');
                    bubble.style.background = 'rgba(200, 200, 200, 0.5)';
                    bubble.style.color = '#999';
                } else {
                    bubble.classList.remove('won-prize');
                    bubble.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                    bubble.style.color = '#333';
                }
            });
        }

        function clearAllConfig() {
            if (confirm('确定要清空所有配置和抽奖记录吗？')) {
                localStorage.clear();
                prizes = ['特等奖', '一等奖', '二等奖', '三等奖', '谢谢惠顾'];
                prizeProbabilities = { '特等奖': 5, '一等奖': 10, '二等奖': 15, '三等奖': 20, '谢谢惠顾': 50 };
                wonPrizeTypes = [];
                isNonRepeatableEnabled = false;
                isCountdownEnabled = false;
                countdownTime = 3;
                drawCount = 1;
                countdownMode = 'manual';
                localStorage.setItem('prizes', JSON.stringify(prizes));
                localStorage.setItem('prizeProbabilities', JSON.stringify(prizeProbabilities));
                localStorage.setItem('nonRepeatable', 'false');
                localStorage.setItem('countdownEnabled', 'false');
                localStorage.setItem('countdownTime', countdownTime);
                localStorage.setItem('drawCount', drawCount);
                localStorage.setItem('countdownMode', countdownMode);
                localStorage.setItem('lotteryPassword', '123');
                localStorage.setItem('roundCounter', roundCounter);
                initPrizes();
                generateProbabilityInputs();
                loadRecords();
                updateRoundCounter();
                document.getElementById('nonRepeatCheckbox').checked = false;
                document.getElementById('enableCountdownCheckbox').checked = false;
                document.getElementById('countdownTimeInput').value = countdownTime;
                document.getElementById('drawCountInput').value = drawCount;
                document.querySelector('input[name="countdownMode"][value="manual"]').checked = true;
                document.getElementById('countdownTimer').style.display = 'none';
                alert('所有配置和抽奖记录已清空，恢复为默认设置。');
            }
        }

        function closeLotteryEndAlert() {
            document.getElementById('lotteryEndAlert').style.display = 'none';
        }

        function updateRoundCounter() {
            document.getElementById('roundCounter').textContent = `当前轮次: ${roundCounter}`;
        }

        window.addEventListener('resize', initPrizes);
        document.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !isDrawing) startLottery();
        });
    </script>
</body>
</html>