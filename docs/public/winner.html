<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¸è¿å¤§æŠ½å¥– ä¼˜åŒ–ç‰ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f4f4f4, #e0e0e0);
            color: #333;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }

        h1, h2, h3 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
        }

        h1 {
            margin-top: 40px;
            font-size: 2.4em;
        }

        .container {
            text-align: center;
            margin-bottom: 30px;
            z-index: 2;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #007aff, #005bbb);
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        button:hover {
            background: linear-gradient(135deg, #0066cc, #004a99);
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .confirm-btn-save {
            background: linear-gradient(135deg, #ff9500, #e08600);
        }

        .confirm-btn-save:hover {
            background: linear-gradient(135deg, #e08600, #c77300);
        }

        .confirm-btn-clear {
            background: linear-gradient(135deg, #4cd964, #38c84a);
        }

        .confirm-btn-clear:hover {
            background: linear-gradient(135deg, #38c84a, #2ea741);
        }

        .exit-btn {
            background: linear-gradient(135deg, #ff4444, #cc3333);
        }

        .exit-btn:hover {
            background: linear-gradient(135deg, #cc3333, #aa2222);
        }

        .export-btn {
            background: linear-gradient(135deg, #ff9500, #e08600);
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #e08600, #c77300);
        }

        #bubble-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 1;
        }

        .prize-bubble {
            position: absolute;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85));
            color: #333;
            padding: 16px 24px;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: default;
            user-select: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(200, 200, 255, 0.5);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .prize-bubble.large {
            padding: 24px 36px;
            font-size: 1.5em;
        }

        .prize-bubble.small {
            padding: 12px 20px;
            font-size: 0.9em;
        }

        .prize-bubble:hover {
            border-color: #007aff;
            transform: scale(1.08);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .prize-bubble.active {
            background: linear-gradient(135deg, #ffdd66, #ffcc00) !important;
            color: #fff !important;
            z-index: 3;
            transform: scale(1.15);
        }

        .prize-bubble.winner-effect {
            background: linear-gradient(135deg, #4cd964, #38c84a) !important;
            color: #fff !important;
            z-index: 4;
            transform: scale(1.15);
        }

        .prize-bubble.won-prize {
            background: rgba(200, 200, 200, 0.5) !important;
            color: #999 !important;
            transform: scale(1);
            opacity: 0.6;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(2deg); }
            50% { transform: translateY(-12px) rotate(-2deg); }
        }

        @keyframes confetti {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(150px) scale(0.5); }
        }

        .emoji {
            position: absolute;
            font-size: 180px;
            pointer-events: none;
            animation: confetti 1.5s ease-out forwards;
        }

        #settingsPanel, #historyPanel {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            padding: 20px;
            overflow: auto;
            backdrop-filter: blur(8px);
        }

        #settingsPanel::before, #historyPanel::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: -1;
        }

        #settingsContent, #historyContent {
            background: #fff;
            padding: 25px;
            border-radius: 12px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
        }

        #settingsContent .section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        #settingsContent .section:last-child {
            border-bottom: none;
        }

        #settingsContent textarea, #passwordPanel input[type="password"] {
            width: 100%;
            max-width: 300px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: border-color 0.3s ease;
            font-size: 14px;
            margin: 0 auto;
            display: block;
        }

        #settingsContent textarea:focus, #passwordPanel input[type="password"]:focus {
            border-color: #007aff;
            outline: none;
        }

        #settingsContent textarea {
            resize: vertical;
            max-height: 200px;
            overflow-y: auto;
        }

        #settingsContent input[type="number"] {
            width: 60px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-align: right;
            font-size: 14px;
            margin-left: 10px;
        }

        #probabilityInputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .probability-input-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .probability-input-item label {
            flex: 1;
            font-size: 14px;
            color: #555;
        }

        .probability-input-item input {
            width: 60px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #ccc;
            text-align: right;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .probability-input-item input:focus {
            border-color: #007aff;
            outline: none;
        }

        #totalProbability {
            color: #f44336;
            font-weight: bold;
        }

        .settings-options .option-group {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .settings-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #555;
            cursor: pointer;
        }

        .settings-options input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #007aff;
            border-radius: 4px;
            position: relative;
            transition: background-color 0.3s ease;
        }

        .settings-options input[type="checkbox"]:checked {
            background: #007aff;
        }

        .settings-options input[type="checkbox"]:checked::after {
            content: 'âœ”';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 14px;
        }

        .settings-options input[type="radio"] {
            margin-left: 10px;
        }

        #historyContent table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #historyContent th, #historyContent td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        #historyContent th {
            background: #f5f5f5;
            font-weight: bold;
        }

        #historyContent tbody tr:nth-child(even) {
            background: #fafafa;
        }

        #lotteryEndAlert {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #fff, #f0f0ff);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid #4cd964;
            z-index: 1001;
            text-align: center;
            overflow: hidden;
            max-width: 300px;
        }

        #lotteryEndAlert::before {
            content: 'ğŸ‰ ğŸŠ ğŸ ğŸ’° ğŸ† âœ¨';
            position: absolute;
            top: -30px;
            left: 0;
            width: 100%;
            font-size: 40px;
            text-align: center;
            white-space: nowrap;
            animation: emojiScroll 10s linear infinite;
        }

        #lotteryEndAlert::after {
            content: 'ğŸˆ ğŸ‚ ğŸ¥‡ ğŸ¥ˆ ğŸ¥‰ ğŸµ';
            position: absolute;
            bottom: -30px;
            left: 0;
            width: 100%;
            font-size: 40px;
            text-align: center;
            white-space: nowrap;
            animation: emojiScroll 10s linear infinite reverse;
        }

        @keyframes emojiScroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        #lotteryEndAlert h2 {
            background: linear-gradient(90deg, #ff4444, #ff9500, #4cd964, #007aff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        #lotteryEndAlert p {
            font-size: 1em;
            color: #555;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        #lotteryEndAlert .prize-name {
            font-weight: bold;
            color: #4cd964;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        #lotteryEndAlert .congrats-text {
            font-style: italic;
            color: #555;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
        }

        #lotteryEndAlert button {
            background: linear-gradient(135deg, #4cd964, #38c84a);
            border-radius: 50px;
            padding: 10px 20px;
        }

        #roundCounter {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 20px;
            color: #333;
            z-index: 5;
        }

        #countdownTimer {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 150px;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 24px;
            border-radius: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            font-size: 20px;
            color: #333;
            z-index: 5;
        }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            button {
                padding: 10px 20px;
                font-size: 14px;
            }

            .prize-bubble {
                padding: 12px 20px;
                font-size: 0.9em;
            }

            .prize-bubble.large {
                padding: 18px 28px;
                font-size: 1.2em;
            }

            .prize-bubble.small {
                padding: 8px 16px;
                font-size: 0.7em;
            }

            #lotteryEndAlert {
                max-width: 200px;
                padding: 15px;
            }

            #lotteryEndAlert h2 {
                font-size: 2em;
            }

            #lotteryEndAlert p {
                font-size: 0.9em;
            }

            #lotteryEndAlert button {
                padding: 8px 16px;
                font-size: 12px;
            }

            #roundCounter {
                padding: 8px 16px;
                font-size: 16px;
                right: 10px;
            }

            #countdownTimer {
                padding: 8px 16px;
                font-size: 16px;
                right: 100px;
            }
        }
    </style>
</head>
<body>
    <div id="bubble-container"></div>
    <div class="container">
        <h1>å¹¸è¿å¤§æŠ½å¥–</h1>
        <div class="buttons">
            <button id="startBtn" onclick="startLottery()">å¼€å§‹æŠ½å¥–</button>
            <button id="stopBtn" onclick="stopLottery()" style="display:none;">åœæ­¢æŠ½å¥–</button>
            <button onclick="toggleSettings()">æŠ½å¥–è®¾ç½®</button>
            <button onclick="toggleHistoryPanel()">æŠ½å¥–è®°å½•</button>
        </div>
    </div>

    <div id="settingsPanel">
        <h2>æŠ½å¥–è®¾ç½®</h2>
        <div id="passwordPanel">
            <div style="text-align: center;">
                <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                <button onclick="checkPassword()" style="margin: 10px;">ç¡®è®¤</button>
                <button class="exit-btn" onclick="toggleSettings()" style="margin: 10px;">é€€å‡ºè®¾ç½®</button>
            </div>
        </div>
        <div id="settingsContent" style="display:none;">
            <div class="section">
                <h3>å¥–å“åˆ—è¡¨</h3>
                <textarea id="prizeList" rows="5" placeholder="è¯·è¾“å…¥å¥–å“ï¼Œæ¯è¡Œä¸€ä¸ªï¼ˆæœ€å¤š50ä¸ªï¼‰"></textarea>
                <button onclick="importPrizes()">å¯¼å…¥å¥–å“</button>
            </div>
            <div class="section">
                <h3>ä¸­å¥–æ¦‚ç‡è®¾ç½®</h3>
                <div id="probabilityInputs"></div>
                <p>æ€»æ¦‚ç‡: <span id="totalProbability">0</span>%</p>
                <p style="font-size: 12px; color: #666;">è¯´æ˜ï¼šé¡µé¢å…±æœ‰200ä¸ªæ°”æ³¡ï¼Œå¥–å“æ•°é‡æ ¹æ®æ¦‚ç‡åˆ†é…ã€‚ä¾‹å¦‚ï¼Œæ¦‚ç‡ä¸º50%çš„å¥–å“å°†åˆ†é…100ä¸ªæ°”æ³¡ã€‚</p>
                <div class="setting-buttons" style="display: flex; gap: 10px; justify-content: center;">
                    <button onclick="autoDistribute()">å¹³å‡åˆ†é…</button>
                    <button onclick="clearProbabilities()">æ¸…é™¤æ¯”ä¾‹</button>
                </div>
            </div>
            <div class="section">
                <h3>åŠŸèƒ½é€‰é¡¹</h3>
                <div class="settings-options">
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="nonRepeatCheckbox" onclick="toggleNonRepeatable()"> ä¸é‡å¤ä¸­å¥–
                        </label>
                    </div>
                    <div class="option-group">
                        <label>
                            <input type="checkbox" id="enableCountdownCheckbox" onclick="toggleCountdown()"> å€’è®¡æ—¶å™¨
                            <input type="number" id="countdownTimeInput" min="1" max="5" value="3" placeholder="ç§’æ•° (1-5)"> ç§’
                            <input type="number" id="drawCountInput" min="1" value="1" placeholder="æŠ½å¥–æ¬¡æ•°"> æŠ½å¥–æ¬¡æ•°
                        </label>
                        <div style="margin-top: 10px;">
                            <label><input type="radio" name="countdownMode" value="manual" checked onclick="updateCountdownMode()"> æ‰‹åŠ¨æ¨¡å¼</label>
                            <label><input type="radio" name="countdownMode" value="auto" onclick="updateCountdownMode()"> è‡ªåŠ¨æ¨¡å¼</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="setting-buttons" style="display: flex; gap: 10px; justify-content: center;">
                <button class="confirm-btn-save" onclick="saveProbabilities()">ä¿å­˜è®¾ç½®</button>
                <button class="confirm-btn-clear" onclick="clearAllConfig()">æ¸…ç©ºå…¨éƒ¨é…ç½®</button>
                <button class="exit-btn" onclick="toggleSettings()">é€€å‡ºè®¾ç½®</button>
            </div>
        </div>
    </div>

    <div id="historyPanel">
        <h2>æŠ½å¥–è®°å½•</h2>
        <div id="historyContent"></div>
        <div class="setting-buttons" style="display: flex; gap: 10px; justify-content: center;">
            <button class="export-btn" onclick="exportRecords()">å¯¼å‡ºè®°å½•</button>
            <button class="exit-btn" onclick="clearRecords()">æ¸…ç©ºè®°å½•</button>
            <button onclick="toggleHistoryPanel()">å…³é—­</button>
        </div>
    </div>

    <div id="lotteryEndAlert">
        <h2 id="prizeTitle">ğŸ‰ <span class="prize-name"></span> ğŸ‰</h2>
        <p id="congratsMessage"><span class="congrats-text"></span></p>
        <button onclick="closeLotteryEndAlert()">ç¡®å®š</button>
    </div>

    <div id="countdownTimer">å€’è®¡æ—¶: 0ç§’</div>
    <div id="roundCounter">å½“å‰è½®æ¬¡: 0</div>

    <script>
        let prizes = JSON.parse(localStorage.getItem('prizes')) || ['ç‰¹ç­‰å¥–', 'ä¸€ç­‰å¥–', 'äºŒç­‰å¥–', 'ä¸‰ç­‰å¥–', 'è°¢è°¢æƒ é¡¾'];
        let prizeProbabilities = JSON.parse(localStorage.getItem('prizeProbabilities')) || {
            'ç‰¹ç­‰å¥–': 5, 'ä¸€ç­‰å¥–': 10, 'äºŒç­‰å¥–': 15, 'ä¸‰ç­‰å¥–': 20, 'è°¢è°¢æƒ é¡¾': 50
        };
        let isDrawing = false;
        let intervalId = null;
        let currentIndex = 0;
        let wonPrizeTypes = JSON.parse(localStorage.getItem('wonPrizeTypes')) || [];
        let isNonRepeatableEnabled = JSON.parse(localStorage.getItem('nonRepeatable')) || false;
        let isCountdownEnabled = JSON.parse(localStorage.getItem('countdownEnabled')) || false;
        let countdownTime = parseInt(localStorage.getItem('countdownTime')) || 3;
        let drawCount = parseInt(localStorage.getItem('drawCount')) || 1;
        let countdownMode = localStorage.getItem('countdownMode') || 'manual';
        let remainingDraws = 0;
        let countdownInterval = null;
        const password = localStorage.getItem('lotteryPassword') || '123';
        if (!localStorage.getItem('lotteryPassword')) localStorage.setItem('lotteryPassword', '123');
        let allBubbles = [];
        const MAX_PRIZES = 50;
        const TOTAL_BUBBLES = 200;
        let roundCounter = parseInt(localStorage.getItem('roundCounter')) || 0;

        const congratsMessages = [
            "å“ˆå“ˆï¼Œä»Šå¤©è¿æ°”çˆ†æ£šå•Šï¼",
            "ç‰›å•Šï¼Œæ™šä¸Šè¯·å®¢ä¸ï¼Ÿ",
            "æˆ‘çš„å¤©ï¼Œè¿æ°”ç‹å°±æ˜¯ä½ ï¼",
            "ä½ è¿™æ˜¯è¦é€†å¤©å•Šï¼Œå…„å¼Ÿï¼",
            "å“‡å¡ï¼Œèµ¶ç´§å»ç‚«è€€ä¸€æ³¢å§ï¼",
            "ä¸å¾—äº†ï¼Œä½ æ˜¯æŠ½å¥–ç•Œçš„éšè—å¤§ä½¬å§ï¼Ÿ",
            "æ­å–œæ­å–œï¼Œä»Šæ™šç¡ç€éƒ½èƒ½ç¬‘é†’ï¼",
            "å“å‘€ï¼Œä½ è¿™è¿æ°”èƒ½å»ä¹°å½©ç¥¨äº†å§ï¼Ÿ",
            "å‰å®³äº†æˆ‘çš„å“¥ï¼Œç¾¡æ…•æ­»æˆ‘äº†ï¼",
            "ä½ è¿™æ˜¯è¦ä¸Šå¤©å’Œå¤ªé˜³è‚©å¹¶è‚©å•Šï¼",
            "å“ˆå“ˆå“ˆï¼Œä»Šå¤©æ˜¯ä½ çš„å¹¸è¿æ—¥ï¼",
            "å¤©å•Šï¼Œä½ è¿™æ‰‹æ°”ä¹Ÿå¤ªé€†å¤©äº†å§ï¼",
            "æ­å–œä½ å•Šï¼Œèµ¶ç´§å‘ä¸ªæœ‹å‹åœˆæ˜¾æ‘†ä¸€ä¸‹ï¼",
            "ä¸å¾—äº†ï¼Œä½ è¿™æ˜¯è¦æˆä¸ºä¼ å¥‡å•Šï¼",
            "å“‡ï¼Œä»Šå¤©ä½ æ˜¯å…¨åœºæœ€é“çš„ä»”ï¼",
            "ä¸­å¥–å•¦ï¼Œä½ è¿™è¿æ°”æˆ‘æœäº†ï¼",
            "å˜¿ï¼ŒæŠ½å¥–å¤§å¸ˆå°±æ˜¯ä½ æ²¡é”™äº†ï¼",
            "æ­å–œä½ ï¼Œç¬‘å¾—æˆ‘è„¸éƒ½æŠ½ç­‹äº†ï¼",
            "ç‰›é€¼ï¼Œä½ è¿™æ˜¯è¦æŠ¢èµ°æ‰€æœ‰å¥½è¿å•Šï¼",
            "å“ˆå“ˆï¼Œè¿æ°”å¥½å¾—è®©äººæƒ³æŠ¥è­¦ï¼",
            "ä½ è¿™æ‰‹æ°”ï¼Œç®€ç›´æ˜¯å¼€æŒ‚äº†å§ï¼",
            "å¤©é€‰ä¹‹äººå•Šï¼Œä½©æœä½©æœï¼",
            "å“‡å¡ï¼Œä»Šå¤©ä½ æ˜¯æŠ½å¥–ç•Œçš„æ‰›æŠŠå­ï¼",
            "æ­å–œå•¦ï¼Œèµ¶ç´§å»åº†ç¥ä¸€æ³¢å§ï¼",
            "ä¸å¾—äº†ï¼Œä½ è¿™è¿æ°”èƒ½å¼€åº—äº†å§ï¼",
            "å“ˆå“ˆï¼Œä»Šå¤©ä½ æ˜¯å…¨åœºç„¦ç‚¹ï¼",
            "ä¸­å¥–å•¦ï¼Œç¬‘å¾—æˆ‘çœ¼æ³ªéƒ½å‡ºæ¥äº†ï¼",
            "ç‰›å•Šï¼Œä½ è¿™æ˜¯è¦ä¸Šå¤©å•Šï¼",
            "æ­å–œä½ ï¼Œè¿æ°”å¥½å¾—è®©äººå«‰å¦’ï¼",
            "å“‡ï¼Œä½ è¿™æ˜¯è¦ç«éå…¨ç½‘å•Šï¼"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nonRepeatCheckbox').checked = isNonRepeatableEnabled;
            document.getElementById('enableCountdownCheckbox').checked = isCountdownEnabled;
            document.getElementById('countdownTimeInput').value = countdownTime;
            document.getElementById('drawCountInput').value = drawCount;
            document.querySelector(`input[name="countdownMode"][value="${countdownMode}"]`).checked = true;
            initPrizes();
            updateRoundCounter();
            toggleCountdown();
        });

        function initPrizes() {
            const bubbleContainer = document.getElementById('bubble-container');
            bubbleContainer.innerHTML = '';
            wonPrizeTypes = JSON.parse(localStorage.getItem('wonPrizeTypes')) || [];
            allBubbles = [];

            let bubbleCounts = {};
            let assignedBubbles = 0;

            prizes.forEach(prize => {
                let count = Math.round(TOTAL_BUBBLES * (prizeProbabilities[prize] / 100));
                bubbleCounts[prize] = count;
                assignedBubbles += count;
            });

            let diff = TOTAL_BUBBLES - assignedBubbles;
            if (diff !== 0) {
                let lastPrize = prizes[prizes.length - 1];
                bubbleCounts[lastPrize] += diff;
                if (bubbleCounts[lastPrize] < 0) bubbleCounts[lastPrize] = 0;
            }

            let totalToCreate = 0;
            for (let prize in bubbleCounts) totalToCreate += bubbleCounts[prize];

            function createBubbles(index = 0) {
                if (index >= prizes.length) return;
                const prize = prizes[index];
                for (let i = 0; i < bubbleCounts[prize] && allBubbles.length < totalToCreate; i++) {
                    const bubble = document.createElement('div');
                    bubble.className = 'prize-bubble';
                    bubble.textContent = prize;
                    bubble.dataset.prizeName = prize;

                    if (Math.random() > 0.5) {
                        bubble.classList.add('large');
                    } else {
                        bubble.classList.add('small');
                    }

                    if (isNonRepeatableEnabled && wonPrizeTypes.includes(prize)) {
                        bubble.classList.add('won-prize');
                    }

                    let left, top, attempts = 0;
                    const title = document.querySelector('h1');
                    const titleRect = title ? title.getBoundingClientRect() : { left: 0, right: 0, top: 0, bottom: 0 };
                    do {
                        left = Math.random() * (bubbleContainer.offsetWidth - bubble.offsetWidth);
                        top = Math.random() * (Math.min(bubbleContainer.offsetHeight * 0.8, window.innerHeight) - bubble.offsetHeight);
                        attempts++;
                    } while (attempts < 100 &&
                        left > titleRect.left - 100 &&
                        left < titleRect.right + 100 &&
                        top > titleRect.top - 50 &&
                        top < titleRect.bottom + 50);

                    bubble.style.left = `${left}px`;
                    bubble.style.top = `${top}px`;
                    bubble.style.animation = `float ${3 + Math.random() * 3}s infinite ${Math.random() * 3}s`;
                    bubbleContainer.appendChild(bubble);
                    allBubbles.push(bubble);
                }
                if (allBubbles.length < totalToCreate) {
                    requestAnimationFrame(() => createBubbles(index + 1));
                } else {
                    loadWonPrizesVisual();
                }
            }
            createBubbles();
        }

        function startLottery() {
            if (isDrawing) return;
            isDrawing = true;
            let bubbles = allBubbles.filter(bubble => !(isNonRepeatableEnabled && wonPrizeTypes.includes(bubble.dataset.prizeName)));

            if (isNonRepeatableEnabled && bubbles.length === 0) {
                isDrawing = false;
                document.getElementById('lotteryEndAlert').style.display = 'block';
                document.getElementById('prizeTitle').innerHTML = 'ğŸ‰ <span class="prize-name">æ‰€æœ‰å¥–å“å·²æŠ½å®Œï¼</span> ğŸ‰';
                document.getElementById('congratsMessage').innerHTML = '';
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
                return;
            }

            bubbles.forEach(b => {
                b.classList.remove('active', 'winner-effect');
                b.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                b.style.color = '#333';
            });
            currentIndex = Math.floor(Math.random() * bubbles.length);

            intervalId = setInterval(() => {
                bubbles[currentIndex].classList.remove('active');
                bubbles[currentIndex].style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                bubbles[currentIndex].style.color = '#333';
                currentIndex = (currentIndex + 1) % bubbles.length;
                bubbles[currentIndex].classList.add('active');
                bubbles[currentIndex].style.background = 'linear-gradient(135deg, #ffdd66, #ffcc00)';
                bubbles[currentIndex].style.color = '#fff';
            }, 60);

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('stopBtn').disabled = isCountdownEnabled;

            if (isCountdownEnabled) {
                remainingDraws = drawCount;
                startCountdown();
            }
        }

        function startCountdown() {
            let timeLeft = countdownTime;
            document.getElementById('countdownTimer').style.display = 'block';
            document.getElementById('countdownTimer').textContent = `å€’è®¡æ—¶: ${timeLeft}ç§’`;

            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('countdownTimer').textContent = `å€’è®¡æ—¶: ${timeLeft}ç§’`;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    stopLottery();
                    if (countdownMode === 'auto' && remainingDraws > 0) {
                        let remainingBubbles = allBubbles.filter(b => !(isNonRepeatableEnabled && wonPrizeTypes.includes(b.dataset.prizeName)));
                        if (remainingBubbles.length > 0) {
                            setTimeout(startLottery, 1000);
                        } else {
                            document.getElementById('countdownTimer').style.display = 'none';
                        }
                    } else {
                        document.getElementById('countdownTimer').style.display = 'none';
                    }
                }
            }, 1000);
        }

        function stopLottery() {
            if (!isDrawing) return;
            isDrawing = false;
            clearInterval(intervalId);
            if (countdownInterval) clearInterval(countdownInterval);

            let bubbles = allBubbles.filter(bubble => !(isNonRepeatableEnabled && wonPrizeTypes.includes(bubble.dataset.prizeName)));
            if (isNonRepeatableEnabled && bubbles.length === 0) {
                document.getElementById('lotteryEndAlert').style.display = 'block';
                document.getElementById('prizeTitle').innerHTML = 'ğŸ‰ <span class="prize-name">æ‰€æœ‰å¥–å“å·²æŠ½å®Œï¼</span> ğŸ‰';
                document.getElementById('congratsMessage').innerHTML = '';
                document.getElementById('countdownTimer').style.display = 'none';
                return;
            }

            const winner = bubbles[currentIndex];
            const prize = winner.dataset.prizeName;

            bubbles.forEach(b => {
                b.classList.remove('active');
                b.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                b.style.color = '#333';
            });

            winner.classList.remove('active');
            winner.classList.add('winner-effect');
            winner.style.background = 'linear-gradient(135deg, #4cd964, #38c84a)';
            winner.style.color = '#fff';

            const emojis = ['ğŸ‰', 'ğŸŠ', 'ğŸ', 'ğŸ’°', 'ğŸ†', 'âœ¨', 'ğŸˆ', 'ğŸ‚', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸµ', 'ğŸ¸', 'ğŸ¤', 'ğŸ­', 'ğŸª', 'ğŸ®', 'ğŸ°', 'ğŸ³', 'ğŸ¯'];
            for (let i = 0; i < 6; i++) {
                const emoji = document.createElement('div');
                emoji.className = 'emoji';
                emoji.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                emoji.style.left = `${Math.random() * 300 - 150}px`;
                emoji.style.top = `${Math.random() * 300 - 150}px`;
                winner.appendChild(emoji);
            }

            if (isNonRepeatableEnabled) {
                wonPrizeTypes.push(prize);
                localStorage.setItem('wonPrizeTypes', JSON.stringify(wonPrizeTypes));
                loadWonPrizesVisual();
            }

            roundCounter++;
            localStorage.setItem('roundCounter', roundCounter);
            saveRecord(prize);
            updateRoundCounter();

            const randomMessage = congratsMessages[Math.floor(Math.random() * congratsMessages.length)];
            document.getElementById('lotteryEndAlert').style.display = 'block';
            document.getElementById('prizeTitle').innerHTML = `ğŸ‰ <span class="prize-name">${prize}</span> ğŸ‰`;
            document.getElementById('congratsMessage').innerHTML = `<span class="congrats-text">${randomMessage}</span>`;

            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('stopBtn').style.display = 'none';
            remainingDraws--;
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            if (panel.style.display === 'block') {
                document.getElementById('passwordPanel').style.display = 'block';
                document.getElementById('settingsContent').style.display = 'none';
            }
        }

        function checkPassword() {
            const inputPassword = document.getElementById('password').value;
            if (inputPassword === password) {
                document.getElementById('passwordPanel').style.display = 'none';
                document.getElementById('settingsContent').style.display = 'block';
                generateProbabilityInputs();
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        }

        function importPrizes() {
            const list = document.getElementById('prizeList').value.split('\n')
                .map(item => item.trim())
                .filter(item => item);

            if (list.length === 0) {
                alert('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªå¥–å“ï¼');
                return;
            }
            if (list.length > MAX_PRIZES) {
                alert(`å¥–å“ç§ç±»ä¸å¾—è¶…è¿‡ ${MAX_PRIZES} ä¸ªï¼`);
                return;
            }

            prizes = list;
            prizeProbabilities = {};
            wonPrizeTypes = [];
            localStorage.removeItem('wonPrizeTypes');
            prizes.forEach(prize => prizeProbabilities[prize] = 0);
            localStorage.setItem('prizes', JSON.stringify(prizes));
            localStorage.setItem('prizeProbabilities', JSON.stringify(prizeProbabilities));

            initPrizes();
            generateProbabilityInputs();
            alert('å¥–å“å¯¼å…¥æˆåŠŸï¼è¯·è®¾ç½®ä¸­å¥–æ¦‚ç‡ã€‚');
        }

        function generateProbabilityInputs() {
            const container = document.getElementById('probabilityInputs');
            container.innerHTML = '';

            prizes.forEach(prize => {
                const div = document.createElement('div');
                div.className = 'probability-input-item';
                div.innerHTML = `
                    <label>${prize}:</label>
                    <input type="number" step="1" value="${prizeProbabilities[prize] || 0}"
                           min="0" max="100" onchange="updateTotalProbability()">
                    <span>%</span>
                `;
                container.appendChild(div);
            });
            updateTotalProbability();
        }

        function updateTotalProbability() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            let total = Array.from(inputs).reduce((sum, input) => sum + parseInt(input.value || 0), 0);
            document.getElementById('totalProbability').textContent = total;
        }

        function autoDistribute() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            const avg = Math.floor(100 / inputs.length);
            let remaining = 100 - avg * inputs.length;

            inputs.forEach((input, index) => {
                input.value = avg + (index < remaining ? 1 : 0);
            });
            updateTotalProbability();
        }

        function clearProbabilities() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            inputs.forEach(input => input.value = 0);
            updateTotalProbability();
        }

        function saveProbabilities() {
            const inputs = document.querySelectorAll('#probabilityInputs input');
            let total = Array.from(inputs).reduce((sum, input) => sum + parseInt(input.value || 0), 0);

            if (total !== 100) {
                alert('æ€»æ¦‚ç‡å¿…é¡»ä¸º100%ï¼');
                return;
            }

            prizeProbabilities = {};
            inputs.forEach((input, index) => {
                prizeProbabilities[prizes[index]] = parseFloat(input.value);
            });

            localStorage.setItem('prizeProbabilities', JSON.stringify(prizeProbabilities));
            initPrizes();
            alert('æ¦‚ç‡è®¾ç½®ä¿å­˜æˆåŠŸï¼');
            toggleSettings();
        }

        function saveRecord(prize) {
            const records = JSON.parse(localStorage.getItem('lotteryRecords') || '[]');
            records.push({
                round: roundCounter,
                time: new Date().toLocaleString(),
                prize: prize
            });
            localStorage.setItem('lotteryRecords', JSON.stringify(records));
        }

        function toggleHistoryPanel() {
            const panel = document.getElementById('historyPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
            if (panel.style.display === 'block') loadRecords();
        }

        function loadRecords() {
            const content = document.getElementById('historyContent');
            content.innerHTML = '';
            const records = JSON.parse(localStorage.getItem('lotteryRecords') || '[]');
            if (records.length === 0) {
                content.innerHTML = '<p>æš‚æ— æŠ½å¥–è®°å½•</p>';
                return;
            }

            let tableHTML = '<table><thead><tr><th>è½®æ¬¡</th><th>æ—¶é—´</th><th>å¥–å“åç§°</th></tr></thead><tbody>';
            records.forEach(record => {
                tableHTML += `<tr><td>${record.round}</td><td>${record.time}</td><td>${record.prize}</td></tr>`;
            });
            tableHTML += '</tbody></table>';
            content.innerHTML = tableHTML;
        }

        function clearRecords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æŠ½å¥–è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('lotteryRecords');
                wonPrizeTypes = [];
                localStorage.removeItem('wonPrizeTypes');
                roundCounter = 0;
                localStorage.setItem('roundCounter', roundCounter);
                loadRecords();
                initPrizes();
                updateRoundCounter();
                alert('æŠ½å¥–è®°å½•å·²æ¸…ç©ºï¼Œç¨‹åºå·²æ¢å¤åˆå§‹çŠ¶æ€ã€‚');
            }
        }

        function exportRecords() {
            const records = JSON.parse(localStorage.getItem('lotteryRecords') || '[]');
            if (records.length === 0) {
                alert('æš‚æ— è®°å½•å¯å¯¼å‡ºã€‚');
                return;
            }

            let mdContent = "# æŠ½å¥–è®°å½•\n\n| è½®æ¬¡ | æ—¶é—´ | å¥–å“åç§° |\n|------|------|----------|\n";
            records.forEach(record => {
                mdContent += `| ${record.round} | ${record.time} | ${record.prize} |\n`;
            });

            const blob = new Blob([mdContent], { type: 'text/markdown;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "lottery_records.md");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function toggleNonRepeatable() {
            isNonRepeatableEnabled = document.getElementById('nonRepeatCheckbox').checked;
            localStorage.setItem('nonRepeatable', JSON.stringify(isNonRepeatableEnabled));
            initPrizes();
            loadWonPrizesVisual();
        }

        function toggleCountdown() {
            isCountdownEnabled = document.getElementById('enableCountdownCheckbox').checked;
            countdownTime = Math.max(1, Math.min(5, parseInt(document.getElementById('countdownTimeInput').value) || 3));
            drawCount = Math.max(1, parseInt(document.getElementById('drawCountInput').value) || 1);
            localStorage.setItem('countdownEnabled', JSON.stringify(isCountdownEnabled));
            localStorage.setItem('countdownTime', countdownTime);
            localStorage.setItem('drawCount', drawCount);
            document.getElementById('countdownTimer').style.display = isCountdownEnabled ? 'block' : 'none';
            document.getElementById('countdownTimer').textContent = `å€’è®¡æ—¶: ${countdownTime}ç§’`;
        }

        function updateCountdownMode() {
            countdownMode = document.querySelector('input[name="countdownMode"]:checked').value;
            localStorage.setItem('countdownMode', countdownMode);
        }

        function loadWonPrizesVisual() {
            allBubbles.forEach(bubble => {
                bubble.classList.remove('active', 'winner-effect');
                if (isNonRepeatableEnabled && wonPrizeTypes.includes(bubble.dataset.prizeName)) {
                    bubble.classList.add('won-prize');
                    bubble.style.background = 'rgba(200, 200, 200, 0.5)';
                    bubble.style.color = '#999';
                } else {
                    bubble.classList.remove('won-prize');
                    bubble.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 255, 0.85))';
                    bubble.style.color = '#333';
                }
            });
        }

        function clearAllConfig() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰é…ç½®å’ŒæŠ½å¥–è®°å½•å—ï¼Ÿ')) {
                localStorage.clear();
                prizes = ['ç‰¹ç­‰å¥–', 'ä¸€ç­‰å¥–', 'äºŒç­‰å¥–', 'ä¸‰ç­‰å¥–', 'è°¢è°¢æƒ é¡¾'];
                prizeProbabilities = { 'ç‰¹ç­‰å¥–': 5, 'ä¸€ç­‰å¥–': 10, 'äºŒç­‰å¥–': 15, 'ä¸‰ç­‰å¥–': 20, 'è°¢è°¢æƒ é¡¾': 50 };
                wonPrizeTypes = [];
                isNonRepeatableEnabled = false;
                isCountdownEnabled = false;
                countdownTime = 3;
                drawCount = 1;
                countdownMode = 'manual';
                localStorage.setItem('prizes', JSON.stringify(prizes));
                localStorage.setItem('prizeProbabilities', JSON.stringify(prizeProbabilities));
                localStorage.setItem('nonRepeatable', 'false');
                localStorage.setItem('countdownEnabled', 'false');
                localStorage.setItem('countdownTime', countdownTime);
                localStorage.setItem('drawCount', drawCount);
                localStorage.setItem('countdownMode', countdownMode);
                localStorage.setItem('lotteryPassword', '123');
                localStorage.setItem('roundCounter', roundCounter);
                initPrizes();
                generateProbabilityInputs();
                loadRecords();
                updateRoundCounter();
                document.getElementById('nonRepeatCheckbox').checked = false;
                document.getElementById('enableCountdownCheckbox').checked = false;
                document.getElementById('countdownTimeInput').value = countdownTime;
                document.getElementById('drawCountInput').value = drawCount;
                document.querySelector('input[name="countdownMode"][value="manual"]').checked = true;
                document.getElementById('countdownTimer').style.display = 'none';
                alert('æ‰€æœ‰é…ç½®å’ŒæŠ½å¥–è®°å½•å·²æ¸…ç©ºï¼Œæ¢å¤ä¸ºé»˜è®¤è®¾ç½®ã€‚');
            }
        }

        function closeLotteryEndAlert() {
            document.getElementById('lotteryEndAlert').style.display = 'none';
        }

        function updateRoundCounter() {
            document.getElementById('roundCounter').textContent = `å½“å‰è½®æ¬¡: ${roundCounter}`;
        }

        window.addEventListener('resize', initPrizes);
        document.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !isDrawing) startLottery();
        });
    </script>
</body>
</html>